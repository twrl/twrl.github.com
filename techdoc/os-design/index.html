<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>twrl - OS Design Document</title>
        
        <meta charset="UTF-8"/>
        <meta name="google-site-verification" content="m1FBHjRwb73L9re4eVRIILTFytDvEedTsaAHvlQKYi0" />
        
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Droid+Sans+Mono' rel='stylesheet' type='text/css'/>
        
        <link href="/css/layout.css" rel="stylesheet" type="text/css"/>
        <link href="/css/colour.css" rel="stylesheet" type="text/css"/>
        <link href="/css/code.css" rel="stylesheet" type="text/css"/>
        <link href="/css/typecue.css" rel="stylesheet" type="text/css"/>
	    <link href="/css/colorbox.css" rel="stylesheet" type="text/css"/>
        
        <link href="/atom.xml" rel="alternate" type="application/atom+xml"/>
        <link href="/index.rss" rel="alternate" type="application/rss+xml"/>

	    <link rel="alternate" href="./index.html" id="desktop" media="only screen"/>
        <link rel="alternate" href="./mobile.html" id="phone" media="only screen and (max-device-width: 640px)"/>
	    <link rel="canonical" href="http://twrl.github.com/techdoc/os-design/index.html"/>

        
        
	<meta name="viewport" content="width=640px"/>

        <!-- typography -->
        <style type="text/css">
        body {
            font-family: "Droid Sans", sans-serif;
        }
        pre {
            font-family: "Droid Sans Mono", monospace;
        }
        </style>
        
        
        <script type="application/javascript" src="/js/require.js" data-main="/js/main"></script>
        
        
        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'twrl'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.defer = true;
            s.type = 'text/javascript';
            s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
        </script>

        <script>
          (function() {
            var cx = '011691644366972436714:mfxko1ksw0i';
            var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
          })();
        </script>
        
    </head>
    <body>

        <div id="l-head" class="cf layout-row c-dark">
            <header id="l-head-title" class="cf layout-cell-l2">
                <h1>twrl</h1>
            </header>
            <nav id="l-head-nav" class="cf layout-cell-l3">
            
                
                <p><a href="/">Home</a></p>
                
                
                
                <p><a href="/about/">About</a></p>
                

                
            
                
                <p><a href="/archive/">Archive</a></p>
                

                <p data-widget="site/expand" style="float:right; text-align: right"><a href="mobile.html" title="Mobile view"><span class="expanding">Mobile</span><img src="/images/icons/mobile.png" alt="Mobile view" class="cf rlicon expander" style="height: 20px; max-width: 20px;"/></a></p>
                
                
            
            </nav>
        </div>

	<div id="viewport">

        
        <div class="cf layout-row c-dark" id="l-advnav">
                        <div class="cf layout-cell-r2">
                <h4><img src="/images/icons/46.png" class="icon"/>About me</h4>
                <img src="//lh4.googleusercontent.com/-sThPEpky3Eg/AAAAAAAAAAI/AAAAAAAAACg/Ncrk_nbS_5k/s512-c/photo.jpg" style="float: right; max-width: 80px; max-height: 80px; margin: 1ex 1em;"/>
                <p>I used to write code for a living, but since discovered that being a full time student is much more fun. Now studying for a masters in Mathematics, I fill my spare time with tinkering with computers and occasionally getting angry at the news - and write about both of those things here.</p>

                <h4><img src="/images/icons/16.png" class="icon"/>Search</h4>
                <gcse:searchbox-only></gcse:searchbox-only>
                
            </div>


        </div>
        <div class="cf layout-row c-dark" id="l-advnavctl" data-widget="site/advnav" style="display: none;">
            <div class="cf layout-cell-l5" id="l-advnavctl-ctrl">
                <p id="advnavctl-show"><img src="/images/icons/24.png" class="cf llicon"/> Show me more things...</p>
                <p id="advnavctl-hide" style="display:none"><img src="/images/icons/19.png" class="cf llicon"/> Hide this clutter</p>
            </div>
        </div>
        
    
                <article about="/techdoc/os-design/index.html">
        <section class="cf layout-row odd">
            <header class="cf layout-cell-l2">
                <h1>OS Design Document</h1>

                <p style="margin-bottom: 32px;"><span typeof="Breadcrumb"><a href="/techdoc">Technical Documents</a></span></p>

                <p>Specifies the design for my operatng system, focusing on the divison into HAL and Kernel.</p>

                
                <nav id="l-article-toc" data-widget="site/toc"></nav>

                <div id="share-widget">

    <!-- AddThis Button BEGIN -->
        <div class="addthis_toolbox addthis_default_style">
        <a class="addthis_button_google_plusone_share"><img src="/images/icons/social/google_plus.png"/></a>
        <a class="addthis_button_facebook"><img src="/images/icons/social/facebook.png"/></a>
        <a class="addthis_button_linkedin"><img src="/images/icons/social/linkedin.png"/></a>
        <a class="addthis_button_twitter"><img src="/images/icons/social/twitter.png"/></a>
        <a class="addthis_button_email"><img src="/images/icons/social/email.png"/></a>
        <a class="addthis_button"><img src="/images/icons/112.png"/></a>
        <!--a class="addthis_counter addthis_bubble_style"></a-->
        </div>
        <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
        <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-5002f6cf1dbb4c0f"></script>
        <!-- AddThis Button END -->

</div>

            </header>
            <div class="cf layout-cell-l3 content">
                <ul id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#hardware-abstraction-layer">Hardware Abstraction Layer</a>    <ul>
      <li><a href="#initialization">Initialization</a></li>
    </ul>
  </li>
  <li><a href="#kernel">Kernel</a>    <ul>
      <li><a href="#continuations-and-events">Continuations and Events</a></li>
      <li><a href="#memory">Memory</a></li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>There are several components - the HAL, the hypervisor, and the supervisor. The
hypervisor uses a combination of paravirtualisation and VMx to isolate instances
of the supervisor(s) from each other as a separation kernel - the supervisor is
not an operating system in it&rsquo;s own right and depends on Hypervisor and HAL
services.</p>

<ul>
  <li>The system is partitioned into SysDomains, which in turn are partitioned 
into AppDomains. Separation of SysDomains is enforced using VMx.</li>
</ul>

<h2 id="hardware-abstraction-layer">Hardware Abstraction Layer</h2>

<p>The HAL groups all architecture dependent code together and provides some 
abstractions for use by other components. The HAL also includes initialization
code.</p>

<p>Key things in the HAL are:</p>

<ul>
  <li>Initialization code</li>
  <li>Panic function</li>
  <li>Physical page allocator</li>
  <li>Virtual memory mapper</li>
  <li>Synchronisation primitives (ticket locks)</li>
  <li>IO primitives</li>
  <li>Interrupt manager</li>
  <li>Context switching primitives</li>
</ul>

<h3 id="initialization">Initialization</h3>

<p>The kernel runs in long mode, but GRUB2 will only take us as far as protected
mode. So the HAL contains a 32 bit entry point which activates long mode. This
has the advantage of not needing to redo the paging setup once we hit the
kernel.</p>

<p>Ultimately, the HAL can provide several different entry points for several 
different boot protocols. Multiboot2 is the most immediate - UEFI and/or Pure64
are also possibles. The HAL needs to then</p>

<ol>
  <li>Gather up any data that the boot protocol has passed it</li>
  <li>Set up some reasonable descriptor tables</li>
  <li>Initialize the physical page allocator</li>
  <li>Configure paging and map itself and the kernel somewhere sensible</li>
  <li>Switch to Long Mode</li>
  <li>PROFIT! (or jump to the Kernel&rsquo;s main)</li>
</ol>

<h2 id="kernel">Kernel</h2>

<p>The Kernel does a lot of things that the HAL doesn&rsquo;t, including doing all the
architecture independent abstracting.</p>

<ul>
  <li>Memory allocation</li>
  <li>Software Transactional Memory</li>
  <li>Continuations</li>
  <li>Events</li>
  <li>Message passing</li>
  <li>Smart Pointers and Capabilities</li>
  <li>Garbage Collection</li>
  <li>Loading and Dynamic Linking</li>
</ul>

<h3 id="continuations-and-events">Continuations and Events</h3>

<p>The main Kernel loop pulls continuations out of a queue and runs them. There is 
no scheduler, continuations run until they complete or yield. Should the queue 
be empty the kernel loop will sleep until woken by an interrupt (the PIT, most 
likely).</p>

<p>The kernel loop also polls a queue of events. When an event is found, all 
handlers for that event type are queued in the continuation queue. The HAL&rsquo;s 
interrupt handlers mostly work by queueing up events in this manner, leaving
them for the kernel to deal with.</p>

<p>Interrupts are not the only kind of event - </p>

<h3 id="memory">Memory</h3>

<p>The Kernel also provides memory allocation, smart pointers, STM and garbage
collection. </p>

<p>Smart pointers double as capabilities by allowing control over what actions can 
be performed in a transaction. </p>

<pre><code>Transaction BeginTransaction();
Int64 CommitTransaction(Transaction trans);
void AbortTransaction(Transaction trans);




void stmWriteI8(Ref site, UInt64 offset, Int8 value);
void stmWriteU8(Ref site, UInt64 offset, UInt8 value);
void stmWriteI16(Ref site, UInt64 offset, Int16 value);
void stmWriteU16(Ref site, UInt64 offset, UInt16 value);
void stmWriteI32(Ref site, UInt64 offset, Int32 value);
void stmWriteU32(Ref site, UInt64 offset, UInt32 value);
void stmWriteI64(Ref site, UInt64 offset, Int64 value);
void stmWriteU64(Ref site, UInt64 offset, UInt64 value);
</code></pre>

            </div>
        </section>
        <section class="cf layout-row even">
            <header class="cf layout-cell-l2">
                <h2>Comments</h2>
            </header>
            <div class="cf layout-cell-l3">
                        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'twrl'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </section>
        </article>
        
        <div id="l-colophon" class="cf layout-row">
            <footer class="cf layout-cell-l5">
                <p><a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/deed.en_GB"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/uk/80x15.png" /></a></p>
                <p>Theme and content by <a xmlns:cc="http://creativecommons.org/ns#" href="http://twrl.github.com" property="cc:attributionName" rel="cc:attributionURL">Tom Robbins</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/deed.en_GB">Creative Commons Attribution 2.0 UK: England &amp; Wales License</a>.</p>
        		<p>Icons are <a href="http://min.frexy.com/articles/category/milky/">Milky Icons by Frexy</a></p>
        	</footer>
        </div>

	</div>
    
	<div id="scrollbar" data-widget="site/scroll"><div id="s-track"><div id="s-thumb"></div></div></div>

    </body>
</html>
